# Network Correlation 指标解释设计文档

## 📋 需求背景

在 Network Correlation 展开状态下，需要为非网络岗位的用户提供通俗易懂的网络指标解释，特别是指标变化对交易性能指标的影响说明。

### 目标用户
- **主要用户**：应用运维人员、业务分析师、产品经理等非网络专业人员
- **次要用户**：网络工程师（可快速确认指标含义）

### 核心目标
1. **降低理解门槛**：用通俗语言解释专业网络指标
2. **建立因果关系**：说明网络指标变化如何影响交易性能
3. **提供行动建议**：在检测到问题时给出初步排查方向
4. **保持简洁**：不干扰主要信息展示，按需显示

---

## 🎯 设计方案

### 方案概述
在 Network Correlation 展开状态下，为每个网络指标添加**信息图标（ℹ️）**，点击后显示**浮层卡片**，包含：
1. 指标名称和定义
2. 通俗易懂的解释
3. 对交易性能的影响说明
4. 当前状态评估（正常/异常）
5. 异常时的可能原因

---

## 📐 UI 设计规范

### 1. 信息图标位置
在图表 Legend 中每个指标名称后添加信息图标：

```
┌─────────────────────────────────────────────┐
│ Network Correlation          [Normal] [×]   │
├─────────────────────────────────────────────┤
│ [Availability] [Performance]                │
├─────────────────────────────────────────────┤
│                                             │
│  Chart Area                                 │
│                                             │
│  Legend:                                    │
│  ━ Packet Loss ⓘ                           │
│  ━ Retransmission ⓘ                        │
│  ━ Duplicate ACK ⓘ                         │
└─────────────────────────────────────────────┘
```

### 2. 浮层卡片设计

#### 视觉样式
- **尺寸**：宽度 320px，高度自适应（最大 400px）
- **定位**：智能定位（优先右侧，空间不足时左侧或上方）
- **背景**：`bg-white dark:bg-neutral-800`
- **边框**：`border border-neutral-200 dark:border-neutral-600`
- **阴影**：`shadow-xl`
- **圆角**：`rounded-lg`
- **动画**：淡入 + 缩放效果（200ms）

#### 内容结构
```
┌──────────────────────────────────────┐
│ 📊 Packet Loss                  [×] │ ← Header
├──────────────────────────────────────┤
│ 定义                                 │ ← Definition
│ 网络传输中数据包丢失的比例           │
│                                      │
│ 通俗解释                             │ ← Plain Explanation
│ 就像寄快递时包裹丢失，需要重新寄送。 │
│ 丢包率越高，数据传输越不可靠。       │
│                                      │
│ 对交易的影响                         │ ← Business Impact
│ • 交易响应变慢（需要重传数据）       │
│ • 交易失败率上升（超时或中断）       │
│ • 用户体验下降（页面加载慢）         │
│                                      │
│ 当前状态                             │ ← Current Status
│ ⚠️ 异常 - 丢包率 15%（正常 <1%）    │
│                                      │
│ 可能原因                             │ ← Possible Causes
│ • 网络设备故障或过载                 │
│ • 链路质量差（物理层问题）           │
│ • 防火墙或安全设备丢弃数据包         │
└──────────────────────────────────────┘
```

---

## 📊 指标解释内容

### Performance 指标组（网络性能）

#### 1. Packet Loss（丢包率）

**定义**
```
网络传输过程中数据包丢失的比例
```

**通俗解释**
```
就像寄快递时包裹丢失，需要重新寄送。丢包率越高，数据传输越不可靠。
```

**对交易的影响**
```
• 交易响应时间变长（需要重传丢失的数据）
• 交易失败率上升（重传超时或连接中断）
• 用户体验下降（页面加载缓慢、操作卡顿）
```

**正常范围**
```
< 1%：正常
1% - 5%：轻微影响
> 5%：严重影响交易性能
```

**异常时可能原因**
```
• 网络设备故障或过载（交换机、路由器）
• 物理链路质量差（网线、光纤老化）
• 防火墙或安全设备策略导致丢包
• 网络拥塞（带宽不足）
```

---

#### 2. Retransmission（重传率）

**定义**
```
TCP 协议检测到数据丢失后重新发送的比例
```

**通俗解释**
```
就像打电话时对方没听清，你需要重复说一遍。重传率高说明网络质量差，
需要频繁重复发送数据。
```

**对交易的影响**
```
• 交易处理时间延长（等待重传完成）
• 网络带宽浪费（同样的数据发送多次）
• 服务器负载增加（处理重传请求）
```

**正常范围**
```
< 2%：正常
2% - 10%：轻微影响
> 10%：严重影响交易性能
```

**异常时可能原因**
```
• 网络丢包（参考 Packet Loss）
• 网络延迟抖动（延迟不稳定）
• 接收端处理能力不足（缓冲区溢出）
• 网络路径不稳定（路由频繁变化）
```

---

#### 3. Duplicate ACK（重复确认）

**定义**
```
接收端重复发送确认信号，表示期待的数据包未到达
```

**通俗解释**
```
就像你在等快递，快递员送来的不是你期待的那个包裹，你会一直说"我要的
不是这个"。重复确认多说明数据包到达顺序混乱。
```

**对交易的影响**
```
• 触发快速重传机制（性能下降）
• 网络吞吐量降低（传输效率下降）
• 交易响应时间波动（不稳定）
```

**正常范围**
```
< 3%：正常
3% - 10%：轻微影响
> 10%：严重影响交易性能
```

**异常时可能原因**
```
• 数据包乱序（网络路径不稳定）
• 网络拥塞（队列溢出导致丢包）
• 负载均衡配置不当（会话保持问题）
• 网络设备性能瓶颈
```

---

### Availability 指标组（网络可用性）

#### 4. TCP Setup Success %（TCP 建连成功率）

**定义**
```
TCP 三次握手成功建立连接的比例
```

**通俗解释**
```
就像打电话时能否接通。建连成功率低说明很多"电话"打不通，交易无法开始。
```

**对交易的影响**
```
• 交易无法发起（连接失败）
• 用户看到连接错误提示
• 交易成功率直接下降
```

**正常范围**
```
> 99.5%：正常
95% - 99.5%：轻微影响
< 95%：严重影响交易可用性
```

**异常时可能原因**
```
• 服务器资源耗尽（连接数、内存、CPU）
• 防火墙或安全设备限制（连接数限制、SYN Flood 防护）
• 网络设备故障（交换机、负载均衡器）
• 服务端应用问题（监听队列满、进程崩溃）
```

---

#### 5. TCP RST（TCP 连接重置）

**定义**
```
TCP 连接被强制中断的次数
```

**通俗解释**
```
就像打电话时突然被挂断。RST 多说明连接经常被异常中断，交易无法完成。
```

**对交易的影响**
```
• 正在进行的交易被中断
• 交易失败率上升
• 用户体验极差（操作被打断）
```

**正常范围**
```
< 1%：正常
1% - 5%：轻微影响
> 5%：严重影响交易可用性
```

**异常时可能原因**
```
• 应用程序异常关闭连接（代码 bug、超时设置）
• 防火墙或安全设备主动断开（策略限制、异常流量）
• 服务器资源不足（强制关闭连接释放资源）
• 网络中间设备故障（NAT 设备、负载均衡器）
```

---

## 🔧 技术实现

### 1. 组件结构

创建新组件 `MetricInfoTooltip.tsx`：

```tsx
interface MetricInfo {
  name: string;
  definition: string;
  explanation: string;
  impact: string[];
  normalRange: {
    good: string;
    warning: string;
    critical: string;
  };
  possibleCauses: string[];
}

interface MetricInfoTooltipProps {
  metric: 'packetLoss' | 'retransmission' | 'duplicateAck' | 'tcpSetup' | 'tcpRst';
  currentValue?: number;
  status?: 'normal' | 'warning' | 'critical';
}
```

### 2. 自定义 Legend 组件

修改 `NetworkCorrelationSidebar.tsx`，使用自定义 Legend：

```tsx
const CustomLegend = ({ payload }: any) => {
  return (
    <div className="flex items-center justify-center gap-4 mt-2">
      {payload.map((entry: any, index: number) => (
        <div key={index} className="flex items-center gap-1.5">
          <div 
            className="w-3 h-3 rounded-sm" 
            style={{ backgroundColor: entry.color }}
          />
          <span className="text-xs text-neutral-700 dark:text-neutral-300">
            {entry.value}
          </span>
          <MetricInfoTooltip 
            metric={getMetricKey(entry.value)}
            currentValue={getCurrentValue(entry.dataKey)}
            status={getMetricStatus(entry.dataKey)}
          />
        </div>
      ))}
    </div>
  );
};
```

### 3. 状态计算逻辑

```tsx
const getMetricStatus = (
  metricKey: string, 
  value: number
): 'normal' | 'warning' | 'critical' => {
  const thresholds = {
    loss: { warning: 1, critical: 5 },
    retrans: { warning: 2, critical: 10 },
    dupAck: { warning: 3, critical: 10 },
    setup: { warning: 99.5, critical: 95 }, // 反向阈值
    rst: { warning: 1, critical: 5 },
  };
  
  // 实现阈值判断逻辑
};
```

---

## 🎨 交互设计

### 触发方式
- **鼠标悬停**：显示信息图标高亮状态
- **点击图标**：显示/隐藏浮层卡片
- **点击外部**：关闭浮层
- **ESC 键**：关闭浮层

### 定位策略
1. **优先右侧**：图标右侧 8px 处
2. **空间不足**：自动切换到左侧
3. **垂直居中**：与图标垂直对齐
4. **边界检测**：确保不超出视口

### 动画效果
```css
/* 淡入 + 缩放 */
@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
```

---

## 📱 响应式设计

### 桌面端（> 1024px）
- 浮层宽度：320px
- 定位：智能定位（右侧优先）

### 平板端（768px - 1024px）
- 浮层宽度：280px
- 定位：智能定位

### 移动端（< 768px）
- 浮层宽度：calc(100vw - 32px)
- 定位：居中显示（模态框样式）
- 添加遮罩层

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有 5 个指标都有解释内容
- [ ] 信息图标正确显示在 Legend 中
- [ ] 点击图标能正确显示/隐藏浮层
- [ ] 浮层内容完整且格式正确

### 用户体验
- [ ] 解释内容通俗易懂（非专业人员能理解）
- [ ] 当前状态评估准确（基于实际数据）
- [ ] 浮层定位合理（不遮挡重要信息）
- [ ] 动画流畅自然

### 视觉一致性
- [ ] 遵循设计规范（配色、字体、间距）
- [ ] 深色模式适配完整
- [ ] 响应式布局正常

### 性能
- [ ] 浮层打开/关闭无卡顿
- [ ] 不影响图表渲染性能

---

## 🚀 实施计划

### Phase 1: 基础组件（1-2 天）
- [ ] 创建 `MetricInfoTooltip` 组件
- [ ] 实现基础浮层显示/隐藏逻辑
- [ ] 完成 5 个指标的解释内容

### Phase 2: 集成与优化（1 天）
- [ ] 集成到 `NetworkCorrelationSidebar`
- [ ] 实现自定义 Legend
- [ ] 添加状态计算逻辑

### Phase 3: 交互与动画（0.5 天）
- [ ] 实现智能定位
- [ ] 添加动画效果
- [ ] 响应式适配

### Phase 4: 测试与调优（0.5 天）
- [ ] 功能测试
- [ ] 用户体验测试
- [ ] 性能优化

---

## 📝 备注

### 内容更新机制
- 指标解释内容存储在独立的配置文件中
- 支持后续根据用户反馈调整解释内容
- 可扩展支持多语言

### 可访问性
- 信息图标支持键盘导航（Tab 键）
- 浮层支持 ARIA 属性
- 支持屏幕阅读器

### 未来扩展
- 支持指标趋势图（小型 Sparkline）
- 支持相关指标关联（点击跳转）
- 支持导出指标说明（PDF/图片）

