# Network Metrics Explanation - 设计决策记录

## 📋 文档说明

本文档记录了 Network Correlation 指标解释功能的关键设计决策、考虑因素和选择理由。

---

## 🎯 核心设计决策

### 决策 1: 使用信息图标 + 浮层模式

**决策内容**
- 在 Legend 中每个指标名称后添加小型信息图标（ⓘ）
- 点击图标显示浮层卡片，包含详细解释

**考虑的方案**
1. **方案 A**: 直接在图表下方显示所有解释（被否决）
2. **方案 B**: 使用 Tooltip 悬停显示（被否决）
3. **方案 C**: 信息图标 + 浮层（✅ 采用）
4. **方案 D**: 单独的帮助页面（被否决）

**选择理由**
- ✅ **不干扰主流程**: 默认状态不占用空间，保持界面简洁
- ✅ **按需获取**: 用户主动点击才显示，避免信息过载
- ✅ **空间充足**: 浮层可以容纳更丰富的内容
- ✅ **易于发现**: 信息图标是通用的帮助标识
- ❌ 方案 A 会占用大量空间，影响图表展示
- ❌ 方案 B 悬停容易误触，且移动端不友好
- ❌ 方案 D 需要跳转，打断用户流程

**权衡**
- 需要额外点击操作（但符合用户预期）
- 需要处理浮层定位逻辑（但可以提供更好的体验）

---

### 决策 2: 使用生活化比喻解释专业术语

**决策内容**
- Packet Loss → "像快递丢失"
- Retransmission → "像重复说话"
- Duplicate ACK → "像收错包裹"
- TCP Setup → "像电话接通"
- TCP RST → "像电话挂断"

**考虑的方案**
1. **方案 A**: 使用专业术语 + 技术定义（被否决）
2. **方案 B**: 使用生活化比喻（✅ 采用）
3. **方案 C**: 使用图形化示意图（被否决）

**选择理由**
- ✅ **降低理解门槛**: 非技术人员能快速理解
- ✅ **记忆深刻**: 比喻更容易记住
- ✅ **跨文化通用**: 快递、电话是普遍经验
- ❌ 方案 A 对非技术人员太难理解
- ❌ 方案 C 开发成本高，且不一定更清晰

**权衡**
- 可能不够严谨（但目标用户不需要严谨定义）
- 需要精心选择比喻（已经过多轮讨论验证）

---

### 决策 3: 三级状态评估（正常/警告/严重）

**决策内容**
- 正常: 绿色，指标在正常范围内
- 警告: 黄色，指标轻微超出正常范围
- 严重: 红色，指标严重超出正常范围

**考虑的方案**
1. **方案 A**: 二级状态（正常/异常）（被否决）
2. **方案 B**: 三级状态（正常/警告/严重）（✅ 采用）
3. **方案 C**: 五级状态（优秀/良好/一般/警告/严重）（被否决）

**选择理由**
- ✅ **区分轻重**: 帮助用户判断问题紧急程度
- ✅ **符合直觉**: 红黄绿是通用的状态表示
- ✅ **行动指导**: 不同状态对应不同的处理优先级
- ❌ 方案 A 无法区分轻微和严重问题
- ❌ 方案 C 过于复杂，增加判断成本

**阈值设定依据**
| 指标 | 正常 | 警告 | 严重 | 依据 |
|------|------|------|------|------|
| Packet Loss | <1% | 1-5% | >5% | 行业标准 + 实际经验 |
| Retransmission | <2% | 2-10% | >10% | TCP 协议特性 |
| Duplicate ACK | <3% | 3-10% | >10% | 快速重传触发条件 |
| TCP Setup | >99.5% | 95-99.5% | <95% | SLA 要求 |
| TCP RST | <1% | 1-5% | >5% | 业务影响评估 |

**权衡**
- 阈值可能需要根据实际情况调整（提供配置化能力）
- 不同业务场景可能有不同标准（后续可支持自定义）

---

### 决策 4: 智能定位算法（右侧优先，空间不足时左侧）

**决策内容**
- 默认在图标右侧显示浮层（距离 8px）
- 检测右侧空间不足时，切换到左侧
- 垂直方向与图标对齐，确保不超出视口

**考虑的方案**
1. **方案 A**: 固定在图标右侧（被否决）
2. **方案 B**: 固定在屏幕中央（被否决）
3. **方案 C**: 智能定位（✅ 采用）

**选择理由**
- ✅ **适应性强**: 适应不同屏幕尺寸和窗口大小
- ✅ **避免遮挡**: 确保浮层完全可见
- ✅ **保持关联**: 浮层靠近触发元素，关联性强
- ❌ 方案 A 在小屏幕上可能超出视口
- ❌ 方案 B 失去与触发元素的关联

**定位逻辑**
```typescript
1. 计算图标位置（getBoundingClientRect）
2. 计算浮层尺寸（320px × 400px）
3. 检查右侧空间（viewportWidth - iconRight）
4. 空间充足 → 右侧定位
5. 空间不足 → 左侧定位
6. 检查垂直方向，确保不超出视口
```

**权衡**
- 需要额外的计算逻辑（但性能影响可忽略）
- 可能出现位置跳变（通过动画缓解）

---

### 决策 5: 移动端使用居中模态框

**决策内容**
- 移动端（< 768px）浮层改为屏幕居中显示
- 添加半透明黑色遮罩层
- 点击遮罩层关闭浮层

**考虑的方案**
1. **方案 A**: 与桌面端相同的浮层定位（被否决）
2. **方案 B**: 底部抽屉（被否决）
3. **方案 C**: 居中模态框（✅ 采用）

**选择理由**
- ✅ **空间利用**: 移动端屏幕小，居中模态框更合理
- ✅ **操作便利**: 遮罩层提供明确的关闭区域
- ✅ **视觉焦点**: 模态框更能吸引注意力
- ❌ 方案 A 在小屏幕上浮层可能超出或太小
- ❌ 方案 B 底部抽屉需要额外的滑动操作

**权衡**
- 桌面端和移动端体验不一致（但符合各自平台习惯）
- 需要额外的响应式逻辑（但提升了移动端体验）

---

### 决策 6: 在 Legend 中集成，而非图表内

**决策内容**
- 信息图标放在 Legend 的指标名称后
- 不在图表线条或数据点上添加标记

**考虑的方案**
1. **方案 A**: 在图表线条上添加标记（被否决）
2. **方案 B**: 在数据点上添加标记（被否决）
3. **方案 C**: 在 Legend 中集成（✅ 采用）

**选择理由**
- ✅ **不干扰图表**: 保持图表的清晰度和可读性
- ✅ **位置固定**: Legend 位置固定，易于查找
- ✅ **逻辑清晰**: 指标解释与指标名称在一起，符合直觉
- ❌ 方案 A/B 会使图表变得杂乱，影响数据展示

**权衡**
- 用户需要在 Legend 中查找（但 Legend 通常在显眼位置）
- 无法直接在图表上获取解释（但避免了图表杂乱）

---

### 决策 7: 提供"对交易的影响"而非纯技术解释

**决策内容**
- 每个指标都包含"对交易的影响"部分
- 说明指标变化如何影响交易响应时间、成功率、用户体验

**考虑的方案**
1. **方案 A**: 只提供技术定义（被否决）
2. **方案 B**: 提供技术定义 + 业务影响（✅ 采用）
3. **方案 C**: 只提供业务影响（被否决）

**选择理由**
- ✅ **建立因果关系**: 帮助用户理解"为什么要关注这个指标"
- ✅ **业务视角**: 非技术人员更关心业务影响
- ✅ **行动驱动**: 明确影响后更容易决定是否需要处理
- ❌ 方案 A 无法回答"这个指标为什么重要"
- ❌ 方案 C 缺少技术基础，无法深入理解

**影响描述原则**
1. 使用业务术语（交易、响应时间、成功率）
2. 量化影响（变慢、上升、下降）
3. 关联用户体验（页面加载、操作卡顿）

**权衡**
- 需要准确理解业务场景（已与业务团队确认）
- 不同业务可能有不同影响（提供通用描述）

---

### 决策 8: 异常时提供"可能原因"，正常时提供"保持良好"

**决策内容**
- 指标异常（警告/严重）时，显示"可能原因"列表
- 指标正常时，显示"保持良好"的鼓励信息

**考虑的方案**
1. **方案 A**: 始终显示可能原因（被否决）
2. **方案 B**: 根据状态动态显示（✅ 采用）
3. **方案 C**: 不提供可能原因（被否决）

**选择理由**
- ✅ **按需提供**: 异常时才需要排查原因
- ✅ **正向反馈**: 正常时给予鼓励，提升用户信心
- ✅ **避免混淆**: 正常时不显示原因，避免用户误解
- ❌ 方案 A 正常时显示原因会让用户困惑
- ❌ 方案 C 无法帮助用户排查问题

**可能原因的选择标准**
1. 常见性: 选择最常见的 4 个原因
2. 可操作性: 用户能够理解和验证
3. 层次性: 从网络层到应用层
4. 通用性: 适用于大多数场景

**权衡**
- 原因可能不全面（但覆盖了 80% 的场景）
- 需要定期更新（根据实际问题反馈）

---

### 决策 9: 使用 Portal 渲染浮层

**决策内容**
- 使用 React Portal 将浮层渲染到 `document.body`
- 而非在组件树中直接渲染

**考虑的方案**
1. **方案 A**: 在组件树中直接渲染（被否决）
2. **方案 B**: 使用 Portal 渲染到 body（✅ 采用）

**选择理由**
- ✅ **避免 z-index 冲突**: 渲染到 body 顶层，确保浮层在最上方
- ✅ **避免 overflow 裁剪**: 父容器的 overflow:hidden 不会影响浮层
- ✅ **定位灵活**: 可以使用 fixed 定位，相对于视口定位
- ❌ 方案 A 可能被父容器裁剪或遮挡

**权衡**
- 需要手动管理浮层的生命周期（通过 useEffect 处理）
- 需要手动处理点击外部关闭（通过事件监听处理）

---

### 决策 10: 支持多种关闭方式

**决策内容**
- 点击关闭按钮
- 点击浮层外部
- 按 ESC 键
- 移动端点击遮罩层

**考虑的方案**
1. **方案 A**: 只支持关闭按钮（被否决）
2. **方案 B**: 支持多种关闭方式（✅ 采用）

**选择理由**
- ✅ **符合习惯**: 用户习惯多种关闭方式
- ✅ **提升效率**: 快捷键提升操作效率
- ✅ **容错性**: 误触时容易关闭
- ❌ 方案 A 操作不够灵活

**实现细节**
```typescript
// 关闭按钮: onClick 事件
<button onClick={() => setIsOpen(false)}>

// 点击外部: mousedown 事件监听
useEffect(() => {
  const handleClickOutside = (e) => {
    if (!tooltipRef.current?.contains(e.target)) {
      setIsOpen(false);
    }
  };
  document.addEventListener('mousedown', handleClickOutside);
}, []);

// ESC 键: keydown 事件监听
useEffect(() => {
  const handleEscape = (e) => {
    if (e.key === 'Escape') setIsOpen(false);
  };
  document.addEventListener('keydown', handleEscape);
}, []);

// 遮罩层: onClick 事件（移动端）
<div onClick={() => setIsOpen(false)} />
```

**权衡**
- 需要处理多个事件监听器（但提升了用户体验）
- 需要注意事件冒泡和清理（已正确处理）

---

## 📊 设计决策总结

| 决策 | 核心理由 | 主要权衡 |
|------|---------|---------|
| 信息图标 + 浮层 | 不干扰主流程，按需获取 | 需要额外点击 |
| 生活化比喻 | 降低理解门槛 | 可能不够严谨 |
| 三级状态评估 | 区分轻重，指导行动 | 阈值需要调整 |
| 智能定位 | 适应性强，避免遮挡 | 需要额外计算 |
| 移动端模态框 | 空间利用，操作便利 | 体验不一致 |
| Legend 集成 | 不干扰图表，逻辑清晰 | 需要在 Legend 查找 |
| 业务影响说明 | 建立因果，业务视角 | 需要理解业务 |
| 动态显示原因 | 按需提供，正向反馈 | 原因可能不全 |
| Portal 渲染 | 避免冲突，定位灵活 | 需要手动管理 |
| 多种关闭方式 | 符合习惯，提升效率 | 需要多个监听器 |

---

## 🔄 未来可能的调整

### 短期（1-2 周）
1. **阈值优化**: 根据实际数据调整阈值
2. **文案优化**: 根据用户反馈调整解释内容
3. **性能优化**: 减少重渲染，优化计算

### 中期（1-2 月）
1. **自定义阈值**: 允许用户自定义正常/警告/严重阈值
2. **趋势图**: 在浮层中添加小型趋势图
3. **多语言**: 支持英文版本

### 长期（3-6 月）
1. **AI 建议**: 基于历史数据提供智能建议
2. **关联分析**: 分析多个指标的关联关系
3. **导出功能**: 支持导出指标说明

---

## 📝 决策变更记录

| 日期 | 决策 | 变更内容 | 理由 |
|------|------|---------|------|
| 2024-01-XX | 初始设计 | 确定所有核心决策 | 需求分析完成 |
| - | - | - | - |

---

## 🎯 决策原则

所有设计决策都遵循以下原则：

1. **用户优先**: 以目标用户（非网络岗位）的需求为中心
2. **简单易用**: 降低学习成本，提升使用效率
3. **业务导向**: 关注业务影响，而非纯技术细节
4. **渐进增强**: 基础功能优先，高级功能后续迭代
5. **性能优先**: 不影响现有功能的性能
6. **可维护性**: 代码结构清晰，易于维护和扩展

---

## 📞 反馈渠道

如对设计决策有疑问或建议，请通过以下渠道反馈：

- **产品团队**: 业务需求和用户体验相关
- **开发团队**: 技术实现和性能相关
- **UX 团队**: 交互设计和视觉设计相关

